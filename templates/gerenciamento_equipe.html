<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Equipe - Sistema de RH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v={{ range(1, 1000) | random }}" type="image/x-icon">
</head>
<body>
    <header>
        <nav>
            <h1>Gerenciamento de Equipe</h1>
            <ul>
                <li><a href="/dashboard-page">Dashboard</a></li>
                <li><a href="#" id="logout-button">Sair</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h2>Lista de Funcionários</h2>
        <div id="message-area" class="alert" style="display: none;"></div>

        <div class="form-group">
            <label for="filter-funcao">Filtrar por função:</label>
            <select id="filter-funcao">
                <option value="">Todas</option>
                <option value="administração">Administração</option>
                <option value="recepção">Recepção</option>
                <option value="faxineiro">Faxineiro</option>
                <!-- O gerente pode adicionar mais opções conforme necessário -->
            </select>
        </div>

        <table id="employees-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>Foto</th>
                    <th>Função</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Funcionários serão carregados aqui via JS -->
            </tbody>
        </table>

        <!-- Modal para Edição de Funcionário -->
        <div id="edit-employee-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>Editar Funcionário</h3>
                <form id="edit-employee-form">
                    <input type="hidden" id="edit-employee-id">
                    <div class="form-group">
                        <label for="edit-name">Nome:</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">Email:</label>
                        <input type="email" id="edit-email" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-password">Nova Senha (deixe em branco para não alterar):</label>
                        <input type="password" id="edit-password">
                    </div>
                    <div class="form-group">
                        <label for="edit-funcao">Função:</label>
                        <input type="text" id="edit-funcao" placeholder="Ex: administração, recepção, faxineiro">
                    </div>
                    <button type="submit">Salvar Alterações</button>
                </form>
            </div>
        </div>

        <!-- Modal para Visualização de Pontos do Funcionário -->
        <div id="view-points-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3 id="points-modal-title">Histórico de Pontos de: </h3>
                <table id="employee-points-table">
                    <thead>
                        <tr>
                            <th>Entrada</th>
                            <th>Saída</th>
                            <th>Duração</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Pontos do funcionário serão carregados aqui -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUserRole(['gerente']);

            const employeesTableBody = document.querySelector('#employees-table tbody');
            const editModal = document.getElementById('edit-employee-modal');
            const viewPointsModal = document.getElementById('view-points-modal');
            const editForm = document.getElementById('edit-employee-form');
            const pointsTableBody = document.querySelector('#employee-points-table tbody');
            const filterFuncao = document.getElementById('filter-funcao');
            let allEmployees = [];

            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', () => {
                    editModal.style.display = 'none';
                    viewPointsModal.style.display = 'none';
                });
            });
            window.addEventListener('click', (event) => {
                if (event.target == editModal) {
                    editModal.style.display = 'none';
                }
                if (event.target == viewPointsModal) {
                    viewPointsModal.style.display = 'none';
                }
            });

            async function loadEmployees() {
                try {
                    const response = await fetch('/api/gerente/funcionarios', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();

                    if (response.ok) {
                        allEmployees = data;
                        renderEmployees();
                    } else {
                        showMessage(data.message || 'Erro ao carregar funcionários.', 'danger');
                    }
                } catch (error) {
                    console.error('Erro ao carregar funcionários:', error);
                    showMessage('Erro de conexão ao carregar funcionários.', 'danger');
                }
            }

            function renderEmployees() {
                employeesTableBody.innerHTML = '';
                const funcaoFiltro = filterFuncao.value;
                let filtered = allEmployees;
                if (funcaoFiltro) {
                    filtered = allEmployees.filter(e => (e.funcao || '').toLowerCase() === funcaoFiltro.toLowerCase());
                }
                if (filtered.length > 0) {
                    filtered.forEach(employee => {
                        const row = employeesTableBody.insertRow();
                        row.insertCell().textContent = employee.id;
                        row.insertCell().textContent = employee.nome;
                        row.insertCell().textContent = employee.email;
                        row.insertCell().textContent = employee.telefone || 'N/A';

                        const imgCell = row.insertCell();
                        const img = document.createElement('img');
                        img.src = employee.foto_perfil && employee.foto_perfil !== 'default-user.png'
                            ? `/static/uploads/perfil/${employee.foto_perfil}`
                            : `/static/uploads/perfil/default-user.png`;
                        img.alt = 'Foto de Perfil';
                        img.className = 'profile-pic-small';
                        imgCell.appendChild(img);

                        row.insertCell().textContent = employee.funcao || '';

                        const actionsCell = row.insertCell();
                        const editButton = document.createElement('button');
                        editButton.textContent = 'Editar';
                        editButton.className = 'action-button edit-button';
                        editButton.addEventListener('click', () => openEditModal(employee));
                        actionsCell.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Excluir';
                        deleteButton.className = 'action-button delete-button';
                        deleteButton.addEventListener('click', () => deleteEmployee(employee.id, employee.nome));
                        actionsCell.appendChild(deleteButton);

                        const viewPointsButton = document.createElement('button');
                        viewPointsButton.textContent = 'Ver Pontos';
                        viewPointsButton.className = 'action-button view-points-button';
                        viewPointsButton.addEventListener('click', () => viewEmployeePoints(employee.id, employee.nome));
                        actionsCell.appendChild(viewPointsButton);
                    });
                } else {
                    const row = employeesTableBody.insertRow();
                    row.insertCell().colSpan = 7;
                    row.insertCell().textContent = 'Nenhum funcionário cadastrado.';
                }
            }

            filterFuncao.addEventListener('change', renderEmployees);

            function openEditModal(employee) {
                document.getElementById('edit-employee-id').value = employee.id;
                document.getElementById('edit-name').value = employee.nome;
                document.getElementById('edit-email').value = employee.email;
                document.getElementById('edit-password').value = '';
                document.getElementById('edit-funcao').value = employee.funcao || '';
                editModal.style.display = 'block';
            }

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-employee-id').value;
                const name = document.getElementById('edit-name').value;
                const email = document.getElementById('edit-email').value;
                const password = document.getElementById('edit-password').value;
                const funcao = document.getElementById('edit-funcao').value;

                const payload = { nome: name, email: email, funcao: funcao };
                if (password) {
                    payload.senha = password;
                }

                try {
                    const response = await fetch(`/api/funcionarios/${id}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        showMessage(data.message, 'success');
                        editModal.style.display = 'none';
                        loadEmployees();
                    } else {
                        showMessage(data.message || 'Erro ao atualizar funcionário.', 'danger');
                    }
                } catch (error) {
                    console.error('Erro ao atualizar funcionário:', error);
                    showMessage('Erro de conexão ao atualizar funcionário.', 'danger');
                }
            });

            async function deleteEmployee(id, name) {
                if (confirm(`Tem certeza que deseja excluir o funcionário ${name}? Esta ação é irreversível e removerá todos os dados associados.`)) {
                    try {
                        const response = await fetch(`/api/funcionarios/${id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        const data = await response.json();

                        if (response.ok) {
                            showMessage(data.message, 'success');
                            loadEmployees();
                        } else {
                            showMessage(data.message || 'Erro ao excluir funcionário.', 'danger');
                        }
                    } catch (error) {
                        console.error('Erro ao excluir funcionário:', error);
                        showMessage('Erro de conexão ao excluir funcionário.', 'danger');
                    }
                }
            }

            async function viewEmployeePoints(employeeId, employeeName) {
                document.getElementById('points-modal-title').textContent = `Histórico de Pontos de: ${employeeName}`;
                pointsTableBody.innerHTML = '<tr><td colspan="3">Carregando pontos...</td></tr>';
                viewPointsModal.style.display = 'block';

                try {
                    const response = await fetch(`/api/gerente/pontos/${employeeId}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    const data = await response.json();

                    if (response.ok) {
                        pointsTableBody.innerHTML = '';
                        if (data.pontos.length > 0) {
                            data.pontos.forEach(ponto => {
                                const row = pointsTableBody.insertRow();
                                row.insertCell().textContent = ponto.entrada ? new Date(ponto.entrada).toLocaleString() : 'N/A';
                                row.insertCell().textContent = ponto.saida ? new Date(ponto.saida).toLocaleString() : 'Pendente';

                                let duracao = 'N/A';
                                if (ponto.entrada && ponto.saida) {
                                    const entrada = new Date(ponto.entrada);
                                    const saida = new Date(ponto.saida);
                                    const diffMs = saida - entrada;
                                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                    duracao = `${diffHours}h ${diffMinutes}m`;
                                }
                                row.insertCell().textContent = duracao;
                            });
                        } else {
                            const row = pointsTableBody.insertRow();
                            row.insertCell().colSpan = 3;
                            row.insertCell().textContent = 'Nenhum ponto registrado para este funcionário.';
                        }
                    } else {
                        showMessage(data.message || 'Erro ao carregar pontos do funcionário.', 'danger');
                        pointsTableBody.innerHTML = `<tr><td colspan="3">${data.message || 'Erro ao carregar pontos.'}</td></tr>`;
                    }
                } catch (error) {
                    console.error('Erro ao carregar pontos do funcionário:', error);
                    showMessage('Erro de conexão ao carregar pontos do funcionário.', 'danger');
                    pointsTableBody.innerHTML = `<tr><td colspan="3">Erro de conexão.</td></tr>`;
                }
            }

            loadEmployees();
        });
    </script>