<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Contabilidade - Sistema de RH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <header>
        <nav>
            <h1>Gerenciar Contabilidade</h1>
            <ul>
                <li><a href="/dashboard-page">Dashboard</a></li>
                <li><a href="/gerenciamento-equipe">Gerenciar Equipe</a></li>
                <li><a href="#" id="logout-button">Sair</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div id="message-area" class="alert" style="display: none;"></div>

        <div class="form-section">
            <h2>Selecionar Funcionário</h2>
            <div class="form-group">
                <label for="funcionario-select">Funcionário:</label>
                <select id="funcionario-select" required>
                    <option value="">Selecione um funcionário</option>
                    <!-- Opções serão preenchidas via JavaScript -->
                </select>
            </div>
        </div>

        <div id="contabilidade-form-container" style="display: none;">
            <h2>Dados de Contabilidade - <span id="nome-funcionario"></span></h2>
            
            <form id="contabilidade-form">
                <input type="hidden" id="funcionario-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="salario-base">Salário Base (R$):</label>
                        <input type="number" id="salario-base" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo-contrato">Tipo de Contrato:</label>
                        <select id="tipo-contrato" required>
                            <option value="CLT">CLT</option>
                            <option value="PJ">PJ</option>
                            <option value="Estagiário">Estagiário</option>
                            <option value="Autônomo">Autônomo</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="banco">Banco:</label>
                        <input type="text" id="banco" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="admissao">Data de Admissão:</label>
                        <input type="date" id="admissao" required>
                    </div>
                </div>

                <h3>Benefícios</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="plano-saude">Plano de Saúde (R$):</label>
                        <input type="number" id="plano-saude" step="0.01" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="vale-transporte">Vale Transporte (R$):</label>
                        <input type="number" id="vale-transporte" step="0.01" min="0" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="vale-refeicao">Vale Refeição (R$):</label>
                        <input type="number" id="vale-refeicao" step="0.01" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="bolsa-educacao">Bolsa Educação (R$):</label>
                        <input type="number" id="bolsa-educacao" step="0.01" min="0" value="0">
                    </div>
                </div>

                <h3>Histórico de Pagamentos</h3>
                <div id="historico-pagamentos">
                    <!-- Histórico será gerado dinamicamente -->
                </div>

                <button type="button" id="adicionar-pagamento" class="btn-secondary">+ Adicionar Pagamento</button>

                <div class="form-actions">
                    <button type="submit" id="salvar-contabilidade">Salvar Dados</button>
                    <button type="button" id="cancelar-edicao" class="btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkUserRole(['gerente']);
            
            const funcionarioSelect = document.getElementById('funcionario-select');
            const formContainer = document.getElementById('contabilidade-form-container');
            const contabilidadeForm = document.getElementById('contabilidade-form');
            const nomeFuncionarioSpan = document.getElementById('nome-funcionario');
            const adicionarPagamentoBtn = document.getElementById('adicionar-pagamento');
            const historicoContainer = document.getElementById('historico-pagamentos');

            // Carregar lista de funcionários
            async function carregarFuncionarios() {
                try {
                    const response = await fetch('/api/gerente/funcionarios', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const funcionarios = await response.json();
                        funcionarioSelect.innerHTML = '<option value="">Selecione um funcionário</option>';
                        
                        funcionarios.forEach(func => {
                            const option = document.createElement('option');
                            option.value = func.id;
                            option.textContent = func.nome;
                            funcionarioSelect.appendChild(option);
                        });
                    } else {
                        showMessage('Erro ao carregar funcionários', 'danger');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showMessage('Erro de conexão', 'danger');
                }
            }

            // Quando selecionar um funcionário
            funcionarioSelect.addEventListener('change', async function() {
                const funcionarioId = this.value;
                
                if (!funcionarioId) {
                    formContainer.style.display = 'none';
                    return;
                }
                
                try {
                    // Carregar dados do funcionário
                    const response = await fetch(`/api/funcionarios/${funcionarioId}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const funcionario = await response.json();
                        nomeFuncionarioSpan.textContent = funcionario.nome;
                        document.getElementById('funcionario-id').value = funcionario.id;
                        
                        // Carregar dados de contabilidade
                        await carregarDadosContabilidade(funcionarioId);
                        
                        formContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showMessage('Erro ao carregar dados do funcionário', 'danger');
                }
            });

            // Carregar dados de contabilidade
            async function carregarDadosContabilidade(funcionarioId) {
                try {
                    const response = await fetch(`/api/contabilidade/${funcionarioId}`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        const dados = await response.json();
                        
                        // Preencher formulário com os dados
                        if (dados) {
                            document.getElementById('salario-base').value = dados.salario_base || '';
                            document.getElementById('tipo-contrato').value = dados.tipo_contrato || 'CLT';
                            document.getElementById('banco').value = dados.banco || '';
                            document.getElementById('admissao').value = dados.data_admissao || '';
                            document.getElementById('plano-saude').value = dados.plano_saude || 0;
                            document.getElementById('vale-transporte').value = dados.vale_transporte || 0;
                            document.getElementById('vale-refeicao').value = dados.vale_refeicao || 0;
                            document.getElementById('bolsa-educacao').value = dados.bolsa_educacao || 0;
                            
                            // Carregar histórico
                            carregarHistoricoPagamentos(dados.historico_pagamentos || []);
                        } else {
                            // Limpar formulário se não houver dados
                            contabilidadeForm.reset();
                            historicoContainer.innerHTML = '';
                        }
                    }
                } catch (error) {
                    console.error('Erro:', error);
                }
            }

            // Carregar histórico de pagamentos
            function carregarHistoricoPagamentos(historico) {
                historicoContainer.innerHTML = '';
                
                if (historico.length === 0) {
                    historicoContainer.innerHTML = '<p>Nenhum pagamento registrado.</p>';
                    return;
                }
                
                historico.forEach((pagamento, index) => {
                    const pagamentoDiv = document.createElement('div');
                    pagamentoDiv.className = 'pagamento-item';
                    pagamentoDiv.innerHTML = `
                        <h4>Pagamento ${index + 1}</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Mês/Ano:</label>
                                <input type="month" name="historico[${index}][mes_ano]" value="${pagamento.mes_ano}" required>
                            </div>
                            <div class="form-group">
                                <label>Salário Bruto (R$):</label>
                                <input type="number" name="historico[${index}][salario_bruto]" step="0.01" value="${pagamento.salario_bruto}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Abonos (R$):</label>
                                <input type="number" name="historico[${index}][abonos]" step="0.01" value="${pagamento.abonos}">
                            </div>
                            <div class="form-group">
                                <label>Descontos (R$):</label>
                                <input type="number" name="historico[${index}][descontos]" step="0.01" value="${pagamento.descontos}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Salário Líquido (R$):</label>
                                <input type="number" name="historico[${index}][salario_liquido]" step="0.01" value="${pagamento.salario_liquido}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Status:</label>
                                <select name="historico[${index}][status]">
                                    <option value="Pago" ${pagamento.status === 'Pago' ? 'selected' : ''}>Pago</option>
                                    <option value="Pendente" ${pagamento.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Atrasado" ${pagamento.status === 'Atrasado' ? 'selected' : ''}>Atrasado</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn-remover" data-index="${index}">Remover</button>
                        <hr>
                    `;
                    historicoContainer.appendChild(pagamentoDiv);
                });
            }

            // Adicionar novo pagamento
            adicionarPagamentoBtn.addEventListener('click', function() {
                const index = document.querySelectorAll('.pagamento-item').length;
                const pagamentoDiv = document.createElement('div');
                pagamentoDiv.className = 'pagamento-item';
                pagamentoDiv.innerHTML = `
                    <h4>Novo Pagamento</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Mês/Ano:</label>
                            <input type="month" name="historico[${index}][mes_ano]" required>
                        </div>
                        <div class="form-group">
                            <label>Salário Bruto (R$):</label>
                            <input type="number" name="historico[${index}][salario_bruto]" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Abonos (R$):</label>
                            <input type="number" name="historico[${index}][abonos]" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Descontos (R$):</label>
                            <input type="number" name="historico[${index}][descontos]" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Salário Líquido (R$):</label>
                            <input type="number" name="historico[${index}][salario_liquido]" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Status:</label>
                            <select name="historico[${index}][status]">
                                <option value="Pago">Pago</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Atrasado">Atrasado</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn-remover" data-index="${index}">Remover</button>
                    <hr>
                `;
                historicoContainer.appendChild(pagamentoDiv);
            });

            // Enviar formulário
            contabilidadeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const funcionarioId = document.getElementById('funcionario-id').value;
                const formData = new FormData(this);
                const dados = {
                    salario_base: parseFloat(document.getElementById('salario-base').value),
                    tipo_contrato: document.getElementById('tipo-contrato').value,
                    banco: document.getElementById('banco').value,
                    data_admissao: document.getElementById('admissao').value,
                    plano_saude: parseFloat(document.getElementById('plano-saude').value),
                    vale_transporte: parseFloat(document.getElementById('vale-transporte').value),
                    vale_refeicao: parseFloat(document.getElementById('vale-refeicao').value),
                    bolsa_educacao: parseFloat(document.getElementById('bolsa-educacao').value),
                    historico_pagamentos: []
                };

                // Coletar histórico de pagamentos
                document.querySelectorAll('.pagamento-item').forEach((item, index) => {
                    dados.historico_pagamentos.push({
                        mes_ano: item.querySelector(`input[name="historico[${index}][mes_ano]"]`).value,
                        salario_bruto: parseFloat(item.querySelector(`input[name="historico[${index}][salario_bruto]"]`).value),
                        abonos: parseFloat(item.querySelector(`input[name="historico[${index}][abonos]"]`).value),
                        descontos: parseFloat(item.querySelector(`input[name="historico[${index}][descontos]"]`).value),
                        salario_liquido: parseFloat(item.querySelector(`input[name="historico[${index}][salario_liquido]"]`).value),
                        status: item.querySelector(`select[name="historico[${index}][status]"]`).value
                    });
                });

                try {
                    const response = await fetch(`/api/contabilidade/${funcionarioId}`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dados)
                    });

                    if (response.ok) {
                        showMessage('Dados de contabilidade salvos com sucesso!', 'success');
                    } else {
                        showMessage('Erro ao salvar dados', 'danger');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showMessage('Erro de conexão', 'danger');
                }
            });

            // Inicializar
            carregarFuncionarios();
        });
    </script>
</body>
</html>